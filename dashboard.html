<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EJAT - Live Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>

<nav class="top-nav">
    <a href="index.html" class="nav-tab">Home</a>
    <a href="dashboard.html" class="nav-tab active">Dashboard</a>
    <a href="insights.html" class="nav-tab">Community Insights</a>
</nav>

<div id="container">
    <aside id="sidebar">
        <div class="card">
            <label>Street Address Search</label>
            <input type="text" id="addrInput" placeholder="Enter address in Cheverly...">
            <button onclick="searchAddress()">Locate</button>
        </div>

        <div class="card" style="text-align:center; border-top: 5px solid var(--blue);">
            <label id="stationLabel">SELECT A STATION</label>
            <div id="aqiVal" class="ce-aqi-num" style="color:#ccc;">--</div>
            <div id="statusLabel" style="font-size: 0.7rem; font-weight: bold;">CE-AQI (LIVE)</div>
        </div>

        <div class="card">
            <label>Station Information</label>
            <p id="stationMeta" style="font-size: 0.8rem; color: #666;">Select a sensor on the map to see details and 24-hour trends.</p>
        </div>
    </aside>

    <main id="main-view">
        <div id="map"></div>
        <div id="chart-container">
            <canvas id="aqiChart"></canvas>
        </div>
    </main>
</div>

<script>
    // 1. CONFIGURATION: CE-AQI Adders from Jan 27 Protocol
    const STATION_ADDERS = {
        "53677": 1.03, // Industrial Adder (3%)
        "54239": 1.03,
        "181253": 1.02, // Traffic Adder (2%)
        "default": 1.01 // Residential Baseline (1%)
    };

    // 2. CE-AQI CALCULATION LOGIC
    function calculateCEAQI(pm25, stationId) {
        let baseAQI = 0;
        // Standard EPA Breakpoints
        if (pm25 <= 12.0) baseAQI = (50/12) * pm25;
        else if (pm25 <= 35.4) baseAQI = ((100-51)/(35.4-12.1)) * (pm25 - 12.1) + 51;
        else baseAQI = pm25 + 100; // Simplified high-range

        // Apply Industrial Adder
        const multiplier = STATION_ADDERS[stationId] || STATION_ADDERS["default"];
        return Math.round(baseAQI * multiplier);
    }

    // 3. MAP INITIALIZATION
    const map = L.map('map').setView([38.924, -76.915], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // 4. CHART INITIALIZATION
    const ctx = document.getElementById('aqiChart').getContext('2d');
    const aqiChart = new Chart(ctx, {
        type: 'line',
        data: { datasets: [{ label: 'CE-AQI (Last 24 Hours)', data: [], borderColor: '#4477ce', tension: 0.3 }] },
        options: { scales: { x: { type: 'time', time: { unit: 'hour' } } } }
    });

    // 5. ADDRESS SEARCH (using OpenStreetMap Nominatim)
    async function searchAddress() {
        const query = document.getElementById('addrInput').value;
        const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
        const data = await resp.json();
        if (data.length > 0) {
            map.setView([data[0].lat, data[0].lon], 16);
            L.marker([data[0].lat, data[0].lon]).addTo(map).bindPopup("Your Location").openPopup();
        }
    }

    // Fetching PurpleAir data and updating the UI would go here...
</script>
</body>
</html>
