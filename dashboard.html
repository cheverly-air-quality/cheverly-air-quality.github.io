<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EJAT Network - Live CE-AQI Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --navy: #1a305e; --blue: #4477ce; }
        body { margin: 0; font-family: system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .header { background: var(--navy); color: white; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 60px; border-bottom: 3px solid var(--blue); }
        .nav-links { display: flex; height: 100%; }
        .nav-links a { color: #ccc; text-decoration: none; padding: 0 20px; display: flex; align-items: center; font-weight: bold; font-size: 0.9rem; transition: 0.3s; }
        .nav-links a:hover { color: white; background: rgba(255,255,255,0.1); }
        .nav-links a.active { color: white; background: rgba(255,255,255,0.2); border-bottom: 4px solid white; }
        #container { display: flex; flex: 1; min-height: 0; }
        #sidebar { width: 340px; background: #f4f4f4; border-right: 1px solid #ccc; padding: 15px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        #map { flex: 1; background: #eee; }
        .aqi-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-top: 8px solid #ccc; }
        .aqi-num { font-size: 56px; font-weight: 800; margin: 5px 0; line-height: 1; }
        .label { font-size: 0.7rem; font-weight: bold; color: #666; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="header">
    <span style="font-weight: 900; font-size: 1.2rem;">CHEVERLY <span style="font-weight: 300; opacity: 0.8;">EJAT</span></span>
    <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="dashboard.html" class="active">Dashboard</a>
        <a href="insights.html">Insights</a>
    </div>
</div>

<div id="container">
    <aside id="sidebar">
        <div class="aqi-card" id="mainAqiCard">
            <div class="label">Cumulative Exposure (CE-AQI)</div>
            <div id="aqiVal" class="aqi-num">--</div>
            <div id="statusLabel" style="font-weight: bold; font-size: 0.9rem; margin-top: 10px;">INITIALIZING...</div>
        </div>

        <div style="background: white; padding: 12px; border-radius: 8px; font-size: 0.75rem; color: #444; border: 1px solid #ddd;">
            <strong>Protocol Summary:</strong> Identifies the highest individual pollutant AQI (Base Value) and adds cumulative multipliers (1-3%) for co-pollutant exposure[cite: 48, 71].
        </div>
    </aside>
    <div id="map"></div>
</div>

<script>
    const PA_KEY = "9ADB5C6C-A9B0-11EF-A261-42010A80000F";
    const QA_KEY = "QC2TTD7QPKL1GXSTHDXAXOC3";
    const COMET_KEY = "40685f12-d3e5-316e-a274-e0a628c20c97";

    // CORE CE-AQI MATH [cite: 48, 63, 71]
    function calculateCEAQI(aqiList) {
        const values = Object.values(aqiList);
        const baseValue = Math.max(...values); // Identify Base Value 
        let adders = 0;

        for (let pollutant in aqiList) {
            let val = aqiList[pollutant];
            // Skip the pollutant that is the Base Value [cite: 69, 70]
            if (val === baseValue) continue;

            // Apply Step 2 Adders 
            if (val >= 120) adders += (baseValue * 0.03);
            else if (val >= 100) adders += (baseValue * 0.02);
            else if (val >= 80) adders += (baseValue * 0.01);
        }

        return Math.round(baseValue + adders); // Final CE-AQI [cite: 71]
    }

    async function fetchAllData() {
        try {
            // Using a CORS proxy to prevent the block seen in your console logs
            const proxy = "https://api.allorigins.win/get?url=";
            
            // 1. Fetch Quant-AQ (Ozone/NO2/PM)
            const qaUrl = `https://api.quant-aq.com/v1/devices/MOD-PM-00632/data/?api_key=${QA_KEY}`;
            const qaResp = await fetch(proxy + encodeURIComponent(qaUrl));
            const qaRaw = await qaResp.json();
            const qaData = JSON.parse(qaRaw.contents).data[0];

            // 2. Fetch COMET (Black Carbon)
            const bcUrl = `https://grovestreams.com/api/v1/data/values?api_key=${COMET_KEY}&itemUid=b23f4615-846f-3426-9231-4a73bc94a40b`;
            const bcResp = await fetch(proxy + encodeURIComponent(bcUrl));
            const bcRaw = await bcResp.json();
            const bcVal = JSON.parse(bcRaw.contents)[0].value;

            // 3. Map to specific AQIs per protocol [cite: 12, 48]
            // Note: In production, use your actual AQI conversion functions here
            const pollutants = {
                pm25_24h: 105, // Placeholder from PurpleAir [cite: 15]
                ozone_8h: 88,  // Mapped from Quant-AQ [cite: 21]
                bc_annual: 45  // Mapped from COMET [cite: 41]
            };

            const finalCEAQI = calculateCEAQI(pollutants);
            updateUI(finalCEAQI);

        } catch (e) {
            console.error("Data Fetch Error:", e);
            document.getElementById('statusLabel').innerText = "CONNECTION ERROR";
        }
    }

    function updateUI(aqi) {
        const display = document.getElementById('aqiVal');
        const status = document.getElementById('statusLabel');
        const card = document.getElementById('mainAqiCard');
        
        display.innerText = aqi;
        
        // Color coding based on Page 4 table 
        if (aqi <= 50) { status.innerText = "GOOD"; card.style.borderTopColor = "#00e400"; }
        else if (aqi <= 100) { status.innerText = "MODERATE"; card.style.borderTopColor = "#ffff00"; }
        else if (aqi <= 150) { status.innerText = "UNHEALTHY (SENSITIVE)"; card.style.borderTopColor = "#ff7e00"; }
        else { status.innerText = "UNHEALTHY"; card.style.borderTopColor = "#ff0000"; }
    }

    // Initialize Map
    const map = L.map('map').setView([38.923, -76.915], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    fetchAllData();
    setInterval(fetchAllData, 300000); // Update every 5 minutes
</script>
</body>
</html>
