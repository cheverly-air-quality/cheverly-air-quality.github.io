<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>EJAT Cheverly Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
        #layout { display: flex; flex: 1; }
        #sidebar { width: 300px; background: #f4f4f4; padding: 20px; border-right: 1px solid #ccc; }
        #map { flex: 1; background: #eee; }
        .error-msg { color: red; font-size: 0.8rem; margin-top: 10px; border: 1px solid red; padding: 10px; background: #fff1f1; display: none; }
    </style>
</head>
<body>

<div id="layout">
    <aside id="sidebar">
        <h2>Cheverly Air</h2>
        <p>Current Status:</p>
        <div id="status-box">Connecting to PurpleAir...</div>
        
        <div id="setup-instructions" class="error-msg">
            <strong>Action Required:</strong><br>
            GitHub security is blocking the data. To fix this:<br><br>
            1. <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank">Click Here to Open the Proxy Gate</a><br>
            2. Click the big button that says <strong>"Request temporary access"</strong>.<br>
            3. Come back here and refresh this page.
        </div>

        <select id="devSel" style="width: 100%; margin-top: 20px; padding: 10px;" onchange="updateMap(this.value)">
            <option>Loading Stations...</option>
        </select>
    </aside>
    <div id="map"></div>
</div>

<script>
    const API_KEY = "9ADB5C6C-A9B0-11EF-A261-42010A80000F";
    // This is the strongest proxy, but requires the "CORS Demo" click once
    const PROXY = "https://cors-anywhere.herokuapp.com/";
    
    const SENSORS = {
        "203577": "EJAT.CV.2.203577 (Supersite)",
        "54293": "EJAT.CV.2.54293",
        "52823": "EJAT.CV.6.52823",
        "218273": "EJAT.PG.1.218273"
    };

    const map = L.map('map').setView([38.922, -76.915], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    async function init() {
        const url = PROXY + "https://api.purpleair.com/v1/sensors?nwlng=-77.1&nwlat=39.0&selng=-76.8&selat=38.8&fields=sensor_index,pm2.5_atm,latitude,longitude";
        
        try {
            const resp = await fetch(url, {
                headers: { 
                    "X-API-Key": API_KEY,
                    "X-Requested-With": "XMLHttpRequest" 
                }
            });

            if (resp.status === 403) {
                document.getElementById('setup-instructions').style.display = 'block';
                document.getElementById('status-box').innerText = "Bridge Locked.";
                return;
            }

            const data = await resp.json();
            const sel = document.getElementById('devSel');
            sel.innerHTML = '<option value="">Select a Station</option>';

            data.data.forEach(r => {
                const id = String(r[0]);
                if (SENSORS[id]) {
                    L.circleMarker([r[2], r[3]], {radius: 10, color: 'blue'}).addTo(map).bindPopup(SENSORS[id]);
                    sel.add(new Option(SENSORS[id], id));
                }
            });
            document.getElementById('status-box').innerText = "Connected!";

        } catch (e) {
            console.error(e);
            document.getElementById('setup-instructions').style.display = 'block';
            document.getElementById('status-box').innerText = "Connection Failed.";
        }
    }

    init();
    setTimeout(() => map.invalidateSize(), 1000);
</script>
</body>
</html>
