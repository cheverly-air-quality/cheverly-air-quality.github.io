<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cheverly EJAT Network - Live CE-AQI Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --navy: #1a305e; --blue: #4477ce; }
        body { margin: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
        .header { background: var(--navy); color: white; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .nav-links { display: flex; height: 100%; }
        .nav-links a { color: #ccc; text-decoration: none; padding: 0 15px; display: flex; align-items: center; font-weight: bold; }
        .nav-links a.active { color: white; border-bottom: 4px solid white; background: rgba(255,255,255,0.1); }
        #main { display: flex; flex: 1; overflow: hidden; }
        #sidebar { width: 320px; background: #f4f4f4; border-right: 1px solid #ddd; padding: 20px; overflow-y: auto; }
        #map { flex: 1; background: #eee; }
        .aqi-card { background: white; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-top: 8px solid #ccc; }
        .aqi-val { font-size: 64px; font-weight: 800; margin: 10px 0; }
        .label { font-size: 0.8rem; font-weight: bold; color: #666; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="header">
    <div style="font-weight:bold; font-size: 1.2rem;">Cheverly EJAT Network</div>
    <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="dashboard.html" class="active">Dashboard</a>
        <a href="insights.html">Insights</a>
    </div>
</div>

<div id="main">
    <aside id="sidebar">
        <div class="aqi-card" id="aqiCard">
            <div class="label">Cumulative Exposure (CE-AQI)</div>
            <div class="aqi-val" id="displayAqi">--</div>
            <div id="status" style="font-weight:bold;">Initializing...</div>
        </div>
        <p style="font-size: 0.8rem; color: #555; margin-top: 15px;">
            *Calculated using the Jan 27 protocol: Base Value (highest individual AQI) + multi-pollutant adders.
        </p>
    </aside>
    <div id="map"></div>
</div>

<script>
    // 1. CONFIGURATION & KEYS
    const PA_KEY = "9ADB5C6C-A9B0-11EF-A261-42010A80000F";
    const QA_KEY = "QC2TTD7QPKL1GXSTHDXAXOC3";
    const COMET_API = "40685f12-d3e5-316e-a274-e0a628c20c97";

    // 2. CE-AQI LOGIC (Protocol Step 2)
    function getCEAQI(pollutants) {
        // pollutants = { pm25: aqi, o3: aqi, bc: aqi }
        const values = Object.values(pollutants);
        const baseValue = Math.max(...values); // Highest individual value is the Base
        let totalAdders = 0;

        for (let key in pollutants) {
            let aqi = pollutants[key];
            if (aqi === baseValue) continue; // Don't add the base value twice

            // Thresholds for 1%, 2%, and 3% adders
            if (aqi >= 120) totalAdders += (baseValue * 0.03);
            else if (aqi >= 100) totalAdders += (baseValue * 0.02);
            else if (aqi >= 80) totalAdders += (baseValue * 0.01);
        }
        return Math.round(baseValue + totalAdders);
    }

    // 3. FETCHING DATA
    async function refreshData() {
        try {
            // Quant-AQ Fetch (Ozone/NO2)
            const qaAuth = btoa(QA_KEY + ":");
            const qaResp = await fetch(`https://api.quant-aq.com/v1/devices/MOD-PM-00632/data/`, {
                headers: { 'Authorization': `Basic ${qaAuth}` }
            });
            const qaData = await qaResp.json();
            
            // Black Carbon Fetch (COMET via GroveStreams)
            const bcResp = await fetch(`https://grovestreams.com/api/v1/data/values?api_key=${COMET_API}&itemUid=b23f4615-846f-3426-9231-4a73bc94a40b`);
            const bcData = await bcResp.json();
            
            // Example data mapping for the calculation
            const finalScore = getCEAQI({
                pm25: 75,  // Real-time PurpleAir integration here
                o3: 85,    // Mapped from qaData
                bc: 45     // Mapped from bcData
            });

            document.getElementById('displayAqi').innerText = finalScore;
            updateStatus(finalScore);
        } catch (e) {
            console.error("Connection error", e);
            document.getElementById('status').innerText = "Sensor Offline";
        }
    }

    function updateStatus(aqi) {
        const card = document.getElementById('aqiCard');
        const status = document.getElementById('status');
        if (aqi <= 50) { card.style.borderTopColor = "#00e400"; status.innerText = "Good"; }
        else if (aqi <= 100) { card.style.borderTopColor = "#ffff00"; status.innerText = "Moderate"; }
        else { card.style.borderTopColor = "#ff7e00"; status.innerText = "Unhealthy for Sensitive Groups"; }
    }

    // Initialize
    refreshData();
    setInterval(refreshData, 300000); // Refresh every 5 minutes
</script>
</body>
</html>
