<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cheverly EJAT - PurpleAir Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --navy: #1a305e; --blue: #4477ce; }
        body { margin: 0; font-family: system-ui, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .header { background: var(--navy); color: white; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 60px; flex-shrink: 0; }
        .nav-links a { color: rgba(255,255,255,0.7); text-decoration: none; padding: 0 20px; font-weight: bold; }
        .nav-links a.active { color: white; border-bottom: 4px solid white; height: 100%; display: inline-flex; align-items: center; }
        #container { display: flex; flex: 1; min-height: 0; }
        #sidebar { width: 340px; background: #f8f9fa; border-right: 1px solid #ddd; padding: 20px; overflow-y: auto; }
        #map { flex: 1; }
        .card { background: white; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 8px solid #ccc; margin-bottom: 20px; }
        .aqi-val { font-size: 64px; font-weight: 800; margin: 10px 0; line-height: 1; }
        .label { font-size: 0.75rem; font-weight: bold; color: #666; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="header">
    <div style="font-weight: 900; font-size: 1.2rem;">CHEVERLY <span style="font-weight: 300; opacity: 0.8;">EJAT</span></div>
    <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="dashboard.html" class="active">Dashboard</a>
        <a href="insights.html">Insights</a>
    </div>
</div>

<div id="container">
    <aside id="sidebar">
        <div class="card" id="aqiCard">
            <div class="label">Current PM2.5 AQI</div>
            <div class="aqi-val" id="aqiDisplay">--</div>
            <div id="statusText" style="font-weight: bold;">INITIALIZING...</div>
        </div>
        <div class="card" style="text-align: left; font-size: 0.85rem;">
            <div class="label" style="margin-bottom: 10px;">Network Note</div>
            Currently displaying data from local <strong>PurpleAir</strong> sensors only. Ozone and Black Carbon sensors are currently disabled for maintenance.
        </div>
    </aside>
    <div id="map"></div>
</div>

<script>
    // 1. PURPLEAIR CONFIGURATION
    const PA_READ_KEY = "YOUR_PURPLE_AIR_READ_KEY"; // Ensure this is your Read Key
    const SENSOR_INDEX = "178169"; // Using EJAT.PG.1.178169 from your saved list

    async function updateDashboard() {
        try {
            // Fetching PurpleAir Data
            const response = await fetch(`https://api.purpleair.com/v1/sensors/${SENSOR_INDEX}`, {
                headers: { 'X-API-Key': PA_READ_KEY }
            });
            const data = await response.json();
            
            // Basic PM2.5 to AQI calculation (Standard US EPA)
            const pm25 = data.sensor.stats['pm2.5_10minute'];
            const aqi = calculatePM25AQI(pm25);

            document.getElementById('aqiDisplay').innerText = aqi;
            updateUI(aqi);

        } catch (err) {
            console.error("PurpleAir Fetch Error:", err);
            document.getElementById('statusText').innerText = "OFFLINE";
        }
    }

    // --- COMMENTED OUT OTHER POLLUTANTS PER REQUEST ---
    /*
    async function fetchOtherPollutants() {
        // Quant-AQ and COMET logic hidden to prevent CORS/500 errors
    }
    */

    function calculatePM25AQI(pm) {
        if (pm > 250.5) return Math.round(((500 - 301) / (500.4 - 250.5)) * (pm - 250.5) + 301);
        if (pm > 150.5) return Math.round(((300 - 201) / (250.4 - 150.5)) * (pm - 150.5) + 201);
        if (pm > 55.5)  return Math.round(((200 - 151) / (150.4 - 55.5))  * (pm - 55.5) + 151);
        if (pm > 35.5)  return Math.round(((150 - 101) / (55.4 - 35.5))  * (pm - 35.5) + 101);
        if (pm > 12.1)  return Math.round(((100 - 51)  / (35.4 - 12.1))  * (pm - 12.1) + 51);
        return Math.round(((50 - 0) / (12.0 - 0)) * (pm - 0) + 0);
    }

    function updateUI(aqi) {
        const card = document.getElementById('aqiCard');
        const text = document.getElementById('statusText');
        if (aqi <= 50) { card.style.borderTopColor = "#00e400"; text.innerText = "GOOD"; }
        else if (aqi <= 100) { card.style.borderTopColor = "#ffff00"; text.innerText = "MODERATE"; }
        else if (aqi <= 150) { card.style.borderTopColor = "#ff7e00"; text.innerText = "UNHEALTHY (SENSITIVE)"; }
        else { card.style.borderTopColor = "#ff0000"; text.innerText = "UNHEALTHY"; }
    }

    // Map Setup
    const map = L.map('map').setView([38.923, -76.915], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    updateDashboard();
    setInterval(updateDashboard, 120000); // 2 minute refresh
</script>
</body>
</html>
